<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI 글쓰기 친구</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      body {
        font-family: 'Noto Sans KR', sans-serif;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "@google/generative-ai": "https://esm.sh/@google/generative-ai@0.11.3"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="module">
      import React, { useState, useRef, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenerativeAI } from "@google/generative-ai";

      // --- Gemini API 서비스 설정 ---
      // 중요: 'YOUR_API_KEY' 부분을 실제 발급받은 Google AI Studio API 키로 변경해주세요.
      const API_KEY = 'AIzaSyDl7q9AXRGtn898iBA58aHUCz_2bICHr8Q'; 
      const genAI = new GoogleGenerativeAI(API_KEY);

      async function fetchFeedback(topic, writing) {
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash"});

        const prompt = `
          당신은 한국 초등학생들을 위한 친절하고 격려하는 글쓰기 선생님입니다. 당신의 피드백은 이해하기 쉽고, 긍정적이어야 하며, 학생들이 자신의 생각을 더 잘 표현할 수 있도록 돕는 데 중점을 두어야 합니다. 항상 한국어로 작성해주세요.

          다음은 학생이 작성한 글입니다. 아래 지침에 따라 피드백을 생성해주세요.

          **지침:**
          1.  **매우 친절하고 긍정적인 톤**으로 칭찬을 먼저 해주세요. 학생의 노력을 인정해주세요.
          2.  피드백은 초등학생이 이해하기 쉬운 단어와 문장으로 작성해주세요. 어려운 전문 용어는 피해주세요.
          3.  가장 중요한 것은 **'자신의 생각을 표현하는 힘'**을 길러주는 데 초점을 맞춰주세요. "왜 그렇게 생각했어?", "그때 기분은 어땠어?" 와 같은 질문을 통해 더 깊은 생각을 유도해주세요.
          4.  글의 **주제 관련성**과 **창의성**도 함께 분석하여 칭찬과 격려의 요소로 활용해주세요.
          5.  피드백은 Markdown을 사용하여 다음 세 부분으로 명확하게 구성해주세요:
              *   ### 🌟 칭찬해요!
                  글에서 잘한 점을 2~3가지 구체적으로 칭찬해주세요. (예: "주제에 맞는 재미있는 생각을 했구나!", "자신만의 경험을 솔직하게 표현한 점이 정말 멋져.")
              *   ### 🤔 생각 더하기
                  자신의 생각을 더 깊고 풍부하게 표현할 수 있도록 도와주는 질문이나 제안을 1~2가지 해주세요. 정답을 요구하는 것이 아니라, 학생의 생각을 확장시키는 데 목적이 있습니다. (예: "만약 주인공이 다른 선택을 했다면 어떻게 되었을까?", "그때 느꼈던 감정을 색깔이나 날씨에 비유해본다면 어떨까?")
              *   ### 💡 이렇게 해봐요!
                  다음에 글을 쓸 때 시도해볼 만한 구체적이고 실용적인 팁을 한 가지 알려주세요. (예: "글을 쓰기 전에 떠오르는 생각들을 동그라미로 그리고 연결해보는 '생각 그물'을 만들어보면 도움이 될 거야!", "네가 가장 좋아하는 문장에 더 생생한 표현을 추가해보는 건 어때?")

          ---

          **주제:** ${topic}

          **학생의 글:**
          ${writing}
        `;

        try {
          const result = await model.generateContent(prompt);
          const response = await result.response;
          return response.text();
        } catch (error) {
          console.error("Error generating content:", error);
          throw new Error("Gemini API에서 피드백을 가져오는데 실패했습니다.");
        }
      }

      // --- 아이콘 컴포넌트 ---
      const DocumentArrowDownIcon = (props) => (
        React.createElement('svg', {
          xmlns: "http://www.w3.org/2000/svg",
          fill: "none",
          viewBox: "0 0 24 24",
          strokeWidth: 1.5,
          stroke: "currentColor",
          ...props
        }, React.createElement('path', {
          strokeLinecap: "round",
          strokeLinejoin: "round",
          d: "M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        }))
      );

      // --- 로딩 스피너 컴포넌트 ---
      const Spinner = () => {
        return (
          React.createElement('div', {
            className: "inline-block h-5 w-5 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]",
            role: "status"
          }, React.createElement('span', {
            className: "!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]"
          }, "Loading..."))
        );
      };
      
      // --- 마크다운 렌더러 컴포넌트 ---
      const MarkdownRenderer = ({ text }) => {
        const createMarkup = (rawText) => {
            const html = rawText
                .replace(/### (.*)/g, '<h3 class="font-bold text-xl mt-4 mb-2">$1</h3>')
                .replace(/\* (.*)/g, '<li class="ml-5 list-disc">$1</li>')
                .replace(/\n/g, '<br />');
            return { __html: html };
        };
        return React.createElement('div', { dangerouslySetInnerHTML: createMarkup(text) });
      };

      // --- 피드백 카드 컴포넌트 ---
      const FeedbackCard = ({ topic, writing, feedback }) => {
        return (
          React.createElement('div', { className: "mt-10 border-t-2 border-sky-200 pt-8" },
            React.createElement('div', { className: "bg-amber-50 border-2 border-amber-200 p-6 rounded-xl mb-8" },
              React.createElement('h2', { className: "text-2xl font-bold text-amber-800 mb-4" }, "📝 내가 쓴 글"),
              React.createElement('div', null,
                React.createElement('h3', { className: "font-bold text-lg text-gray-700" }, `주제: ${topic}`),
                React.createElement('p', { className: "mt-2 text-gray-600 whitespace-pre-wrap" }, writing)
              )
            ),
            React.createElement('div', { className: "bg-teal-50 border-2 border-teal-200 p-6 rounded-xl" },
              React.createElement('h2', { className: "text-2xl font-bold text-teal-800 mb-4" }, "🤖 AI 선생님의 피드백"),
              React.createElement('div', { className: "prose prose-lg max-w-none text-gray-700" },
                React.createElement(MarkdownRenderer, { text: feedback })
              )
            )
          )
        );
      };

      // --- 메인 앱 컴포넌트 ---
      const App = () => {
        const [topic, setTopic] = useState('');
        const [writing, setWriting] = useState('');
        const [feedback, setFeedback] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);

        const feedbackRef = useRef(null);

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (!topic.trim() || !writing.trim()) {
            setError('주제와 글을 모두 입력해주세요.');
            return;
          }

          setIsLoading(true);
          setError(null);
          setFeedback('');

          try {
            const result = await fetchFeedback(topic, writing);
            setFeedback(result);
          } catch (err) {
            setError('피드백을 생성하는 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
            console.error(err);
          } finally {
            setIsLoading(false);
          }
        };

        const handlePdfExport = useCallback(() => {
          if (!feedbackRef.current) return;
          
          const { jsPDF } = window.jspdf;
          const content = feedbackRef.current;

          window.html2canvas(content, { scale: 2 }).then((canvas) => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const ratio = canvasWidth / canvasHeight;
            const imgWidth = pdfWidth - 20; // A4 여백 고려
            const imgHeight = imgWidth / ratio;
            
            let heightLeft = imgHeight;
            let position = 10; // 상단 여백
            
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= (pdf.internal.pageSize.getHeight() - 20);

            while (heightLeft > 0) {
              position = -heightLeft + 10;
              pdf.addPage();
              pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
              heightLeft -= (pdf.internal.pageSize.getHeight() - 20);
            }
            
            pdf.save('AI_글쓰기_피드백.pdf');
          });
        }, []);

        const isFormIncomplete = !topic.trim() || !writing.trim();

        return (
          React.createElement('div', { className: "min-h-screen bg-sky-50 text-gray-800" },
            React.createElement('main', { className: "container mx-auto px-4 py-8" },
              React.createElement('header', { className: "text-center mb-10" },
                React.createElement('h1', { className: "text-4xl md:text-5xl font-bold text-sky-700" }, "AI 글쓰기 친구 ✏️"),
                React.createElement('p', { className: "mt-4 text-lg text-sky-600" }, "너의 생각을 멋진 글로 만들어보자!")
              ),
              React.createElement('div', { className: "max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg" },
                React.createElement('form', { onSubmit: handleSubmit },
                  React.createElement('div', { className: "mb-6" },
                    React.createElement('label', { htmlFor: "topic", className: "block text-xl font-bold text-gray-700 mb-2" }, "주제"),
                    React.createElement('input', {
                      id: "topic",
                      type: "text",
                      value: topic,
                      onChange: (e) => setTopic(e.target.value),
                      placeholder: "글쓰기 주제를 입력해봐!",
                      className: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition duration-200"
                    })
                  ),
                  React.createElement('div', { className: "mb-8" },
                    React.createElement('label', { htmlFor: "writing", className: "block text-xl font-bold text-gray-700 mb-2" }, "글쓰기"),
                    React.createElement('textarea', {
                      id: "writing",
                      value: writing,
                      onChange: (e) => setWriting(e.target.value),
                      placeholder: "주제에 맞춰 너의 생각을 자유롭게 적어봐!",
                      rows: 12,
                      className: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition duration-200"
                    })
                  ),
                  React.createElement('div', { className: "flex flex-col sm:flex-row gap-4" },
                    React.createElement('button', {
                      type: "submit",
                      disabled: isFormIncomplete || isLoading,
                      className: "w-full sm:w-auto flex-grow bg-sky-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-sky-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    }, 
                      isLoading ? React.createElement(React.Fragment, null, React.createElement(Spinner, null), "AI 선생님이 읽는 중...") : 'AI 선생님께 제출하기'
                    ),
                    React.createElement('button', {
                      type: "button",
                      onClick: handlePdfExport,
                      disabled: !feedback,
                      className: "w-full sm:w-auto bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    }, 
                      React.createElement(DocumentArrowDownIcon, { className: "h-5 w-5" }),
                      "PDF로 저장하기"
                    )
                  )
                ),
                error && React.createElement('div', { className: "mt-6 text-center text-red-600 bg-red-100 p-3 rounded-lg" }, error),
                React.createElement('div', { ref: feedbackRef },
                  feedback && React.createElement(FeedbackCard, { topic: topic, writing: writing, feedback: feedback })
                )
              ),
              React.createElement('footer', { className: "text-center mt-12 text-gray-500" },
                React.createElement('p', null, "Made with ❤️ for young writers.")
              )
            )
          )
        );
      };

      // --- React 앱 렌더링 ---
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        React.createElement(React.StrictMode, null, React.createElement(App, null))
      );
    </script>
  </body>
</html>